<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×¨×¦××” ×©×œ ××•×¨ ×‘×˜×‘×•×œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤</text></svg>">
    <style>
        body {
            font-family: 'Varela Round', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #f9fffe 0%, #ffecd2 100%);
            color: #232323;
            direction: rtl;
            overflow-x: hidden;
        }

        header {
            background: linear-gradient(90deg, #d53369 0%, #daae51 100%);
            color: #fff;
            padding: 2em 0 1em 0;
            text-align: center;
            letter-spacing: 6px;
            border-bottom-left-radius: 40% 12%;
            border-bottom-right-radius: 40% 12%;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.1);
            font-size: 2.3em;
            text-shadow: 2px 2px 14px #00000055;
        }

        #cart-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(90deg, #36d1c4 0%, #f7797d 100%);
            color: white;
            border: none;
            padding: 14px 22px;
            border-radius: 25px 5px 25px 5px;
            font-size: 1.15em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 18px 0 rgba(0,0,0,0.18);
            z-index: 1001;
            transition: background 0.3s, transform 0.2s;
        }
        #cart-toggle-button:hover {
            background: linear-gradient(90deg, #f7797d 0%, #36d1c4 100%);
            transform: scale(1.08) rotate(-1deg);
        }

        main#products-container {
            padding: 40px 6vw 0 6vw;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 38px;
        }

        .product-card {
            background: linear-gradient(120deg, #f5f7fa 22%, #c9e8fc 100%);
            border-radius: 32px 32px 18px 18px;
            box-shadow: 0 6px 22px 0 rgba(52, 52, 90, 0.15);
            padding: 23px 12px 18px 12px;
            text-align: center;
            position: relative;
            transition: transform 0.22s, box-shadow 0.22s;
            overflow: hidden;
            border: 2px solid #eee;
        }
        .product-card:hover {
            transform: scale(1.04) rotate(-1deg);
            box-shadow: 0 8px 32px 0 rgba(52,52,90,0.22);
            border-color: #d53369;
        }
        .product-card img {
            max-width: 98%;
            height: 190px;
            object-fit: cover;
            border-radius: 28px;
            margin-bottom: 16px;
            border: 4px solid #fff;
            box-shadow: 0 3px 18px 0 rgba(213,51,105,0.12);
            transition: filter 0.2s;
        }
        .product-card img:hover {
            filter: brightness(1.08) saturate(1.2) drop-shadow(0 2px 16px #d5336995);
        }
        .product-card h3 {
            margin: 0 0 5px 0;
            font-size: 1.4em;
            color: #d53369;
        }
        .product-card .price {
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 9px;
            font-size: 1.15em;
        }
        .product-card button {
            background: linear-gradient(90deg, #f7797d 0%, #36d1c4 100%);
            color: #fff;
            border: none;
            padding: 11px 23px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 1px 4px 0 rgba(52,52,90,0.13);
            transition: background 0.22s, transform 0.17s;
        }
        .product-card button:hover {
            background: linear-gradient(90deg, #36d1c4 0%, #f7797d 100%);
            transform: scale(1.05);
        }

        #cart-container {
            position: fixed;
            top: 80px;
            left: 20px;
            background: linear-gradient(120deg, #fff7fa 20%, #e3ffe7 100%);
            border: 2.5px solid #c7ffa7;
            border-radius: 26px;
            padding: 20px 18px 25px 18px;
            box-shadow: 0 2px 28px 0 rgba(0,0,0,0.14);
            max-height: 80vh;
            overflow-y: auto;
            width: 370px;
            display: none;
            z-index: 1000;
            transition: box-shadow 0.2s;
        }
        #cart-container:active, #cart-container:focus-within {
            box-shadow: 0 4px 40px 0 #36d1c455;
        }
        #cart h2 {
            margin: 0 0 13px 0;
            font-size: 1.3em;
            color: #36d1c4;
        }
        #cart ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #cart li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 10px 0;
            border-bottom: 1px solid #e2e2e2;
            font-size: 1.06em;
            gap: 4px;
        }
        #cart li:last-child {
            border-bottom: none;
        }
        .cart-item-details {
            display: flex;
            align-items: center;
            min-width: 0;
        }
        .cart-item-details img {
            width: 46px;
            height: 46px;
            margin-left: 12px;
            border-radius: 16px;
            border: 2px solid #e5e5ff;
            object-fit: cover;
            box-shadow: 0 1px 9px 0 #7fb7ff33;
        }
        .cart-item-info {
            flex-grow: 1;
            text-align: right;
            font-size: 1em;
            min-width: 0;
        }
        .cart-item-info span {
            display: block;
            margin-bottom: 0.2em;
            word-break: break-word;
        }
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .cart-item-quantity button {
            background: linear-gradient(90deg, #f7797d 0%, #36d1c4 100%);
            color: #fff;
            border: none;
            padding: 5px 11px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            margin: 0 2px;
            transition: background 0.2s;
        }
        .cart-item-quantity button:hover {
            background: linear-gradient(90deg, #36d1c4 0%, #f7797d 100%);
        }
        #cart .total {
            font-weight: bold;
            margin-top: 15px;
            text-align: right;
            font-size: 1.16em;
            color: #d53369;
        }
        #checkout-button {
            background: linear-gradient(90deg, #d53369 0%, #36d1c4 100%);
            color: #fff;
            border: none;
            padding: 12px 21px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 1.09em;
            width: 98%;
            margin-top: 17px;
            font-weight: bold;
            transition: background 0.2s, transform 0.13s;
        }
        #checkout-button:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
        }
        #checkout-button:hover:not(:disabled) {
            background: linear-gradient(90deg, #36d1c4 0%, #d53369 100%);
            transform: scale(1.04);
        }

        #checkout-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(141, 228, 255, 0.44);
            justify-content: center;
            align-items: center;
            z-index: 1002;
            backdrop-filter: blur(2.5px);
        }

        #checkout-form {
            background: linear-gradient(120deg, #fff7fa 30%, #e3ffe7 100%);
            padding: 22px 16px 24px 16px;
            border-radius: 25px;
            width: 90%;
            max-width: 470px;
            position: relative;
            box-shadow: 0 4px 44px 0 #36d1c433;
        }
        #checkout-form h2 {
            text-align: center;
            margin-bottom: 18px;
            color: #d53369;
            letter-spacing: 1px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"] {
            width: calc(100% - 14px);
            padding: 8px 7px;
            border: 1.5px solid #d0d0d0;
            border-radius: 7px;
            font-size: 1em;
            box-sizing: border-box;
            background: #f9fdff;
            color: #232323;
            transition: border 0.18s;
        }
        .form-group input:focus {
            border: 1.5px solid #36d1c4;
            outline: none;
        }
        .form-actions {
            text-align: center;
            margin-top: 17px;
        }
        .form-actions button {
            background: linear-gradient(90deg, #28a745 0%, #36d1c4 100%);
            color: #fff;
            border: none;
            padding: 9px 22px;
            border-radius: 19px;
            cursor: pointer;
            font-size: 1.11em;
            margin: 0 10px;
            font-weight: bold;
            transition: background 0.18s, transform 0.13s;
        }
        .form-actions button:hover {
            background: linear-gradient(90deg, #36d1c4 0%, #28a745 100%);
            transform: scale(1.04);
        }
        .close-modal-button {
            background: none;
            border: none;
            font-size: 2.1em;
            cursor: pointer;
            position: absolute;
            top: 12px;
            left: 13px;
            color: #d53369;
            transition: color 0.18s;
        }
        .close-modal-button:hover {
            color: #36d1c4;
        }

        #seat-selection-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(213, 51, 105, 0.08);
            justify-content: center;
            align-items: center;
            z-index: 1003;
            backdrop-filter: blur(2.5px);
        }
        .seat-selection-content {
            background: linear-gradient(120deg, #fff7fa 30%, #e3ffe7 100%);
            padding: 24px 18px 24px 18px;
            border-radius: 25px;
            width: 96%;
            max-width: 700px;
            position: relative;
            max-height: 92vh;
            overflow-y: auto;
            box-shadow: 0 4px 44px 0 #36d1c433;
        }
        .seat-selection-content h2 {
            text-align: center;
            margin-bottom: 22px;
            color: #36d1c4;
        }
        .seats-grid {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 7px;
            margin-bottom: 23px;
        }
        .seat {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d53369 30%, #36d1c4 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.9em;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 8px 0 rgba(52,52,90,0.09);
            border: 2px solid #fff;
            transition: background 0.2s, transform 0.13s;
            user-select: none;
        }
        .seat.selected {
            background: linear-gradient(135deg, #28a745 70%, #36d1c4 100%);
            border: 2px solid #28a745;
            transform: scale(1.12);
        }
        .seat.unavailable {
            background: linear-gradient(135deg, #dc3545 70%, #d53369 100%);
            cursor: not-allowed;
            opacity: 0.5;
            border: 2px solid #aaa;
        }
        .seat-info {
            text-align: right;
            margin-top: 18px;
            font-size: 1.03em;
        }
        .seat-info span {
            display: inline-block;
            margin-left: 19px;
            font-weight: bold;
            color: #333;
            letter-spacing: 1.5px;
        }
        .seat-info .legend-selected {
            background: linear-gradient(135deg, #28a745 70%, #36d1c4 100%);
            width: 17px;
            height: 17px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 7px;
            border: 2px solid #28a745;
        }
        .seat-info .legend-available {
            background: #ccc;
            width: 17px;
            height: 17px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 7px;
            border: 2px solid #fff;
        }
        .seat-info .legend-unavailable {
            background: linear-gradient(135deg, #dc3545 70%, #d53369 100%);
            width: 17px;
            height: 17px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 7px;
            border: 2px solid #dc3545;
        }
        #confirm-seats-button {
            background: linear-gradient(90deg, #28a745 0%, #36d1c4 100%);
            color: #fff;
            border: none;
            padding: 10px 28px;
            border-radius: 19px;
            cursor: pointer;
            font-size: 1.13em;
            margin-top: 12px;
            font-weight: bold;
            transition: background 0.2s, transform 0.13s;
        }
        #confirm-seats-button:hover {
            background: linear-gradient(90deg, #36d1c4 0%, #28a745 100%);
            transform: scale(1.04);
        }

        #redirect-message {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(90deg, #f7797d 0%, #36d1c4 100%);
            color: #fff;
            padding: 35px;
            border-radius: 22px;
            font-size: 1.22em;
            z-index: 1000;
            letter-spacing: 1.3px;
            font-weight: bold;
            text-shadow: 1px 1px 12px #22222277;
            box-shadow: 0 2px 24px 0 #36d1c433;
        }

        @media (max-width: 800px) {
            main#products-container {
                grid-template-columns: 1fr;
                padding: 24px 2vw 0 2vw;
            }
            #cart-container { width: 97vw; left: 1vw; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <header>
        <h1>××™×¨×•×¢×™× ×‘×‘×™×ª ×¤×× ×™ ×§×¤×œ×Ÿ - ×‘×™×ª ××™×œ×¨</h1>
    </header>

    <button id="cart-toggle-button">×”×¦×’/×”×¡×ª×¨ ×¢×’×œ×ª ×§× ×™×•×ª</button>

    <main id="products-container">
    </main>

    <div id="cart-container">
        <div id="cart">
            <h2>×¢×’×œ×ª ×§× ×™×•×ª</h2>
            <ul id="cart-items">
            </ul>
            <div class="total">×¡×”"×›: <span id="cart-total">0.00</span> â‚ª</div>
            <button id="checkout-button">××¢×‘×¨ ×œ×ª×©×œ×•×</button>
        </div>
    </div>

    <div id="checkout-modal">
        <form id="checkout-form">
            <button type="button" class="close-modal-button">&times;</button>
            <h2>×¤×¨×˜×™ ×ª×©×œ×•×</h2>
            <div class="form-group">
                <label for="name">×©× ××œ×:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="email">××™××™×™×œ:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="phone">×˜×œ×¤×•×Ÿ:</label>
                <input type="tel" id="phone" name="phone">
            </div>
            <div class="form-group">
                <label for="address">×›×ª×•×‘×ª:</label>
                <input type="text" id="address" name="address" required>
            </div>
            <div class="form-group">
                <label for="card-number">××¡×¤×¨ ×›×¨×˜×™×¡ ××©×¨××™:</label>
                <input type="text" id="card-number" name="cardNumber" inputmode="numeric" pattern="[0-9\s]{13,19}" autocomplete="cc-number" maxlength="19" placeholder="xxxx xxxx xxxx xxxx" required>
            </div>
            <div class="form-group">
                <label for="expiry-date">×ª××¨×™×š ×ª×¤×•×’×” (MM/YY):</label>
                <input type="text" id="expiry-date" name="expiryDate" pattern="(0[1-9]|1[0-2])\/([0-9]{2})" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" inputmode="numeric" pattern="[0-9]{3,4}" maxlength="4" required>
            </div>
            <div class="form-actions">
                <button type="submit">×‘×¦×¢ ×ª×©×œ×•× (×¡×™××•×œ×¦×™×”)</button>
                <button type="button" class="close-modal-button">×‘×™×˜×•×œ</button>
            </div>
        </form>
    </div>

    <div id="seat-selection-modal">
        <div class="seat-selection-content">
            <button type="button" class="close-modal-button">&times;</button>
            <h2>×‘×—×™×¨×ª ××§×•××•×ª</h2>
            <div class="seats-grid" id="seats-grid">
            </div>
            <div class="seat-info">
                <span class="legend-selected"></span> ××§×•× × ×‘×—×¨
                <span class="legend-available"></span> ××§×•× ×¤× ×•×™
                <span class="legend-unavailable"></span> ××§×•× ×ª×¤×•×¡
            </div>
            <div class="form-actions">
                <button id="confirm-seats-button">××™×©×•×¨ ××§×•××•×ª</button>
            </div>
        </div>
    </div>

    <div id="redirect-message">
        ××•×–×× ×™× ×œ×¨××•×ª ××ª ×©××¨ ×”×ª×•×›× ×™×ª ×©×‘×™×ª ××™×œ×¨ ××¦×™×¢×™×...
    </div>

    <script>
        // Your web app's Firebase configuration - PASTE YOUR CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyDlyDbpwcBcWvFnvYHb84dMEpaQFTjv-HY",
            authDomain: "tester-69fa9.firebaseapp.com",
            projectId: "tester-69fa9",
            storageBucket: "tester-69fa9.firebasestorage.app",
            messagingSenderId: "378563229004",
            appId: "1:378563229004:web:5136b724eb84fd00e44be9",
            measurementId: "G-BFJ1QQM3MS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const productsContainer = document.getElementById('products-container');
        const cartItemsList = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');
        const checkoutButton = document.getElementById('checkout-button');
        const checkoutModal = document.getElementById('checkout-modal');
        const closeModalButtons = document.querySelectorAll('.close-modal-button');
        const checkoutForm = document.getElementById('checkout-form');
        const redirectMessage = document.getElementById('redirect-message');
        const cartToggleButton = document.getElementById('cart-toggle-button');
        const cartContainer = document.getElementById('cart-container');
        const seatSelectionModal = document.getElementById('seat-selection-modal');
        const seatsGrid = document.getElementById('seats-grid');
        const confirmSeatsButton = document.getElementById('confirm-seats-button');

        let cart = [];
        let currentProductForSeatSelection = null;
        let selectedSeatsForProduct = [];
        let allSeats = [];
        let products = [];

        const TOTAL_SEATS = 200;

        // --- Firebase Integration Functions ---

        async function initializeAllSeatsAsAvailable() {
            const seatsRef = db.collection('seats');
            const batch = db.batch();
            let seatsExist = false;

            const existingSeatsSnapshot = await seatsRef.limit(1).get();
            if (!existingSeatsSnapshot.empty) {
                seatsExist = true;
            }

            if (!seatsExist) {
                for (let i = 1; i <= TOTAL_SEATS; i++) {
                    const seatDocRef = seatsRef.doc(String(i));
                    batch.set(seatDocRef, {
                        number: i,
                        available: true
                    });
                }
                try {
                    await batch.commit();
                } catch (error) {
                    console.error("Error initializing seats: ", error);
                }
            }
        }

        async function fetchProducts() {
            try {
                const productsSnapshot = await db.collection('products').get();
                products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            } catch (error) {
                alert("×©×’×™××” ×‘×˜×¢×™× ×ª ××™×¨×•×¢×™×.");
            }
        }

        async function fetchSeats() {
            try {
                const seatsSnapshot = await db.collection('seats').get();
                allSeats = seatsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allSeats.sort((a, b) => a.number - b.number);
            } catch (error) {
                alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ××§×•××•×ª.");
            }
        }

        async function updateSeatAvailabilityInFirebase(seatIds, availableStatus) {
            const batch = db.batch();
            seatIds.forEach(seatId => {
                const seatRef = db.collection('seats').doc(String(seatId));
                batch.update(seatRef, { available: availableStatus });
            });
            try {
                await batch.commit();
            } catch (error) {
                alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×–××™× ×•×ª ×”××§×•××•×ª. × ×¡×” ×©×•×‘.");
                await fetchSeats();
                renderSeats();
            }
        }

        // --- Core UI and Cart Logic ---

        function renderProducts() {
            productsContainer.innerHTML = '';
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card');
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p class="price">${product.price.toFixed(2)} â‚ª</p>
                    <button class="add-to-cart" data-id="${product.id}">×”×•×¡×£ ×œ×¢×’×œ×”</button>
                `;
                productsContainer.appendChild(productCard);
            });
        }

        function updateCartDisplay() {
            cartItemsList.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div class="cart-item-details">
                        <img src="${item.image}" alt="${item.name}">
                        <div class="cart-item-info">
                            <span>${item.name}</span>
                            <span>${item.price.toFixed(2)} â‚ª ×œ×™×—×™×“×”</span>
                            ${item.selectedSeats && item.selectedSeats.length > 0 ? `<br><span>××§×•××•×ª: ${item.selectedSeats.map(s => s.number).join(', ')}</span>` : ''}
                        </div>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="decrease-quantity" data-id="${item.id}" data-type="cart">-</button>
                        <span>${item.quantity}</span>
                        <button class="increase-quantity" data-id="${item.id}" data-type="cart">+</button>
                    </div>
                    <span>×¡×”"×›: ${(item.price * item.quantity).toFixed(2)} â‚ª</span>
                `;
                cartItemsList.appendChild(listItem);
                total += item.price * item.quantity;
            });
            cartTotalElement.textContent = total.toFixed(2);

            if (cart.length === 0) {
                const emptyCartMessage = document.createElement('li');
                emptyCartMessage.textContent = '×”×¢×’×œ×” ×¨×™×§×”';
                cartItemsList.appendChild(emptyCartMessage);
                cartTotalElement.textContent = '0.00';
                checkoutButton.disabled = true;
            } else {
                checkoutButton.disabled = false;
            }
        }

        async function openSeatSelection(productId) {
            currentProductForSeatSelection = products.find(p => p.id === productId);
            selectedSeatsForProduct = [];

            const existingCartItem = cart.find(item => item.id === currentProductForSeatSelection.id);
            if (existingCartItem && existingCartItem.selectedSeats) {
                selectedSeatsForProduct = [...existingCartItem.selectedSeats];
            }

            await fetchSeats();
            renderSeats();
            seatSelectionModal.style.display = 'flex';
        }

        function renderSeats() {
            seatsGrid.innerHTML = '';
            const otherReservedSeats = new Set(
                cart
                    .filter(item => item.id !== currentProductForSeatSelection.id)
                    .flatMap(item => item.selectedSeats ? item.selectedSeats.map(s => s.id) : [])
            );

            allSeats.forEach(seat => {
                const seatElement = document.createElement('div');
                seatElement.classList.add('seat');
                seatElement.textContent = seat.number;
                seatElement.dataset.id = seat.id;

                const isAlreadySelected = selectedSeatsForProduct.some(s => s.id === seat.id);
                const isUnavailable = !seat.available || otherReservedSeats.has(seat.id);

                if (isUnavailable) {
                    seatElement.classList.add('unavailable');
                } else if (isAlreadySelected) {
                    seatElement.classList.add('selected');
                }

                seatElement.addEventListener('click', () => {
                    if (seatElement.classList.contains('unavailable')) {
                        return;
                    }

                    if (seatElement.classList.contains('selected')) {
                        seatElement.classList.remove('selected');
                        selectedSeatsForProduct = selectedSeatsForProduct.filter(s => s.id !== seat.id);
                    } else {
                        seatElement.classList.add('selected');
                        selectedSeatsForProduct.push(seat);
                    }
                });
                seatsGrid.appendChild(seatElement);
            });
        }

        function addToCart(productId, selectedSeats = []) {
            const productToAdd = products.find(p => p.id === productId);
            let existingItemIndex = cart.findIndex(item => item.id === productToAdd.id);

            const previousSelectedSeatIds = existingItemIndex !== -1 && cart[existingItemIndex].selectedSeats
                ? cart[existingItemIndex].selectedSeats.map(s => s.id) : [];

            const newSelectedSeatIds = selectedSeats.map(s => s.id);

            const deselectedSeatIds = previousSelectedSeatIds.filter(id => !newSelectedSeatIds.includes(id));
            if (deselectedSeatIds.length > 0) {
                updateSeatAvailabilityInFirebase(deselectedSeatIds, true);
            }

            const newlySelectedSeatIds = newSelectedSeatIds.filter(id => !previousSelectedSeatIds.includes(id));
            if (newlySelectedSeatIds.length > 0) {
                updateSeatAvailabilityInFirebase(newlySelectedSeatIds, false);
            }

            if (selectedSeats.length > 0) {
                if (existingItemIndex !== -1) {
                    cart[existingItemIndex].selectedSeats = selectedSeats;
                    cart[existingItemIndex].quantity = selectedSeats.length;
                } else {
                    cart.push({ ...productToAdd, quantity: selectedSeats.length, selectedSeats: selectedSeats });
                }
            } else {
                if (existingItemIndex !== -1) {
                    if (cart[existingItemIndex].selectedSeats && cart[existingItemIndex].selectedSeats.length > 0) {
                         cart.splice(existingItemIndex, 1);
                    } else {
                        cart[existingItemIndex].quantity++;
                    }
                } else {
                    cart.push({ ...productToAdd, quantity: 1, selectedSeats: [] });
                }
            }
            updateCartDisplay();
            cartContainer.style.display = 'block';
        }

        function changeQuantity(productId, change, type = 'cart') {
            const itemToUpdate = cart.find(item => item.id === parseInt(productId));
            if (itemToUpdate) {
                if (itemToUpdate.selectedSeats && itemToUpdate.selectedSeats.length > 0) {
                    alert('×›×“×™ ×œ×©× ×•×ª ×›××•×ª ×¢×‘×•×¨ ×¤×¨×™×˜ ×¢× ××§×•××•×ª, ×™×© ×œ×‘×—×•×¨ ××—×“×© ××ª ×”××§×•××•×ª ×“×¨×š ×œ×—×¦×Ÿ "×”×•×¡×£ ×œ×¢×’×œ×”" ×©×œ ×”××™×¨×•×¢.');
                    openSeatSelection(productId);
                    return;
                }
                itemToUpdate.quantity += change;
                if (itemToUpdate.quantity < 1) {
                    cart = cart.filter(item => item.id !== parseInt(productId));
                }
                updateCartDisplay();
            }
        }

        productsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-to-cart')) {
                openSeatSelection(event.target.dataset.id);
            }
        });

        cartItemsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('increase-quantity') || event.target.classList.contains('decrease-quantity')) {
                changeQuantity(event.target.dataset.id, event.target.classList.contains('increase-quantity') ? 1 : -1, 'cart');
            }
        });

        checkoutButton.addEventListener('click', () => {
            if (cart.length > 0) {
                checkoutModal.style.display = 'flex';
            } else {
                alert('×”×¢×’×œ×” ×¨×™×§×”, ×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ×ª×©×œ×•×.');
            }
        });

        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                checkoutModal.style.display = 'none';
                seatSelectionModal.style.display = 'none';
                selectedSeatsForProduct = [];
            });
        });

        checkoutForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            try {
                const purchasedSeatsInfo = cart.flatMap(item => item.selectedSeats ? item.selectedSeats.map(s => ({
                    id: s.id,
                    number: s.number,
                    productName: item.name
                })) : []);

                const purchasedSeatIds = purchasedSeatsInfo.map(s => s.id);
                if (purchasedSeatIds.length > 0) {
                    await updateSeatAvailabilityInFirebase(purchasedSeatIds, false);
                }

                await db.collection('orders').add({
                    customerName: name,
                    customerEmail: email,
                    customerPhone: phone,
                    customerAddress: address,
                    items: cart.map(item => ({
                        productId: item.id,
                        productName: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        selectedSeats: item.selectedSeats ? item.selectedSeats.map(s => s.number) : []
                    })),
                    totalAmount: parseFloat(cartTotalElement.textContent),
                    orderDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                });

                alert(`×ª×•×“×” ×œ×š, ${name}! ×”×–×× ×ª×š ×”×ª×§×‘×œ×” ×‘×”×¦×œ×—×”.\n×¡×š ×”×›×œ ×œ×ª×©×œ×•×: ${cartTotalElement.textContent}`);
                cart = [];
                updateCartDisplay();
                checkoutModal.style.display = 'none';
                checkoutForm.reset();

                redirectMessage.style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'https://bmiller.co.il';
                }, 3000);

            } catch (error) {
                alert("××™×¨×¢×” ×©×’×™××” ×‘×ª×”×œ×™×š ×”×ª×©×œ×•×. × ×¡×” ×©×•×‘.");
                await fetchSeats();
                renderSeats();
            }
        });

        cartToggleButton.addEventListener('click', () => {
            if (cartContainer.style.display === 'none') {
                cartContainer.style.display = 'block';
            } else {
                cartContainer.style.display = 'none';
            }
        });

        confirmSeatsButton.addEventListener('click', () => {
            if (currentProductForSeatSelection) {
                if (selectedSeatsForProduct.length === 0) {
                     const confirmRemove = confirm("×œ× × ×‘×—×¨×• ××§×•××•×ª ×¢×‘×•×¨ ××™×¨×•×¢ ×–×”. ×”×× ×‘×¨×¦×•× ×š ×œ×”×¡×™×¨ ××•×ª×• ××”×¢×’×œ×”?");
                     if (confirmRemove) {
                        cart = cart.filter(item => item.id !== currentProductForSeatSelection.id);
                     } else {
                        return;
                     }
                }
                addToCart(currentProductForSeatSelection.id, selectedSeatsForProduct);
            }
            seatSelectionModal.style.display = 'none';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAllSeatsAsAvailable();
            await fetchProducts();
            await fetchSeats();
            updateCartDisplay();
        });
    </script>
</body>
</html>
