<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הרצאות והופעות - בית מילר</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎤</text></svg>">
    <link href="https://fonts.googleapis.com/css?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Heebo', Arial, sans-serif;
            margin: 0;
            background: #f4f4f4;
            color: #333;
            direction: rtl;
            overflow-x: hidden;
        }
        header {
            background: #222;
            color: #fff;
            padding: 2em 0 1em 0;
            text-align: center;
            font-size: 2.2em;
            letter-spacing: 4px;
            border-bottom-left-radius: 16% 8%;
            border-bottom-right-radius: 16% 8%;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.12);
        }
        #cart-toggle-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 16px 6px 16px 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.12);
            z-index: 1001;
            transition: background 0.2s, transform 0.2s;
        }
        #cart-toggle-button:hover {
            background: #0056b3;
            transform: scale(1.04) rotate(-1deg);
        }
        main#products-container {
            padding: 40px 6vw 0 6vw;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 32px;
        }
        .product-card {
            background: #fff;
            border-radius: 24px 24px 14px 14px;
            box-shadow: 0 3px 12px 0 rgba(52, 52, 90, 0.13);
            padding: 20px 10px 15px 10px;
            text-align: center;
            transition: transform 0.18s, box-shadow 0.18s;
            border: 1.5px solid #e1e1e1;
        }
        .product-card:hover {
            transform: scale(1.03) rotate(-1deg);
            box-shadow: 0 8px 28px 0 rgba(52,52,90,0.16);
            border-color: #007bff;
        }
        .product-card img {
            max-width: 98%;
            height: 180px;
            object-fit: cover;
            border-radius: 22px;
            margin-bottom: 13px;
            border: 3px solid #f1f1f1;
            box-shadow: 0 1px 8px 0 rgba(90,90,130,0.09);
            transition: filter 0.2s;
        }
        .product-card img:hover {
            filter: brightness(1.09) saturate(1.05) drop-shadow(0 2px 7px #007bff33);
        }
        .product-card h3 {
            margin: 0 0 5px 0;
            font-size: 1.3em;
            color: #007bff;
        }
        .product-card .price {
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 9px;
            font-size: 1.12em;
        }
        .product-card button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 1px 4px 0 rgba(52,52,90,0.08);
            transition: background 0.18s, transform 0.13s;
        }
        .product-card button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        #cart-container {
            position: fixed;
            top: 80px;
            left: 20px;
            background: #fff;
            border: 2px solid #d1eaff;
            border-radius: 20px;
            padding: 16px 14px 20px 14px;
            box-shadow: 0 2px 18px 0 rgba(0,0,0,0.11);
            max-height: 80vh;
            overflow-y: auto;
            width: 370px;
            display: none;
            z-index: 1000;
            transition: box-shadow 0.2s;
        }
        #cart-container:active, #cart-container:focus-within {
            box-shadow: 0 4px 24px 0 #007bff33;
        }
        #cart h2 {
            margin: 0 0 13px 0;
            font-size: 1.3em;
            color: #007bff;
        }
        #cart ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #cart li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 10px 0;
            border-bottom: 1px solid #e2e2e2;
            font-size: 1.06em;
            gap: 4px;
        }
        #cart li:last-child {
            border-bottom: none;
        }
        .cart-item-details {
            display: flex;
            align-items: center;
            min-width: 0;
        }
        .cart-item-details img {
            width: 44px;
            height: 44px;
            margin-left: 10px;
            border-radius: 12px;
            border: 2px solid #e5e5ff;
            object-fit: cover;
            box-shadow: 0 1px 6px 0 #7fb7ff22;
        }
        .cart-item-info {
            flex-grow: 1;
            text-align: right;
            font-size: 1em;
            min-width: 0;
        }
        .cart-item-info span {
            display: block;
            margin-bottom: 0.2em;
            word-break: break-word;
        }
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .cart-item-quantity button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 5px 11px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            margin: 0 2px;
            transition: background 0.17s;
        }
        .cart-item-quantity button:hover {
            background: #0056b3;
        }
        #cart .total {
            font-weight: bold;
            margin-top: 15px;
            text-align: right;
            font-size: 1.13em;
            color: #007bff;
        }
        #checkout-button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 11px 19px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.08em;
            width: 98%;
            margin-top: 16px;
            font-weight: bold;
            transition: background 0.18s, transform 0.12s;
        }
        #checkout-button:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
        }
        #checkout-button:hover:not(:disabled) {
            background: #0056b3;
            transform: scale(1.04);
        }
        #checkout-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(151, 195, 255, 0.22);
            justify-content: center;
            align-items: center;
            z-index: 1002;
            backdrop-filter: blur(2.5px);
        }
        #checkout-form {
            background: #fff;
            padding: 20px 14px 22px 14px;
            border-radius: 18px;
            width: 90%;
            max-width: 450px;
            position: relative;
            box-shadow: 0 3px 20px 0 #007bff22;
        }
        #checkout-form h2 {
            text-align: center;
            margin-bottom: 16px;
            color: #007bff;
        }
        .form-group {
            margin-bottom: 13px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"] {
            width: calc(100% - 12px);
            padding: 7px 6px;
            border: 1.5px solid #d0d0d0;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
            background: #f8faff;
            color: #232323;
            transition: border 0.15s;
        }
        .form-group input:focus {
            border: 1.5px solid #007bff;
            outline: none;
        }
        .form-actions {
            text-align: center;
            margin-top: 15px;
        }
        .form-actions button {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 9px 20px;
            border-radius: 13px;
            cursor: pointer;
            font-size: 1.07em;
            margin: 0 8px;
            font-weight: bold;
            transition: background 0.16s, transform 0.11s;
        }
        .form-actions button:hover {
            background: #218838;
            transform: scale(1.03);
        }
        .close-modal-button {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            position: absolute;
            top: 11px;
            left: 11px;
            color: #007bff;
            transition: color 0.14s;
        }
        .close-modal-button:hover {
            color: #28a745;
        }
        #seat-selection-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.06);
            justify-content: center;
            align-items: center;
            z-index: 1003;
            backdrop-filter: blur(2.5px);
        }
        .seat-selection-content {
            background: #fff;
            padding: 24px 18px 24px 18px;
            border-radius: 20px;
            width: 96%;
            max-width: 700px;
            position: relative;
            max-height: 92vh;
            overflow-y: auto;
            box-shadow: 0 3px 24px 0 #22222222;
        }
        .seat-selection-content h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #007bff;
        }
        .seats-grid {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 6px;
            margin-bottom: 18px;
            justify-items: center;
            position: relative;
            background: transparent;
        }
        .seat {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.93em;
            color: #fff;
            font-weight: bold;
            border: 2px solid #fff;
            transition: background 0.2s, transform 0.13s, border 0.15s;
            user-select: none;
        }
        .seat.selected {
            background: #28a745;
            border: 2px solid #28a745;
            transform: scale(1.13);
        }
        .seat.unavailable {
            background: #dc3545;
            cursor: not-allowed;
            opacity: 0.5;
            border: 2px solid #aaa;
        }
        .seat-info {
            text-align: right;
            margin-top: 13px;
            font-size: 1.03em;
        }
        .seat-info span {
            display: inline-block;
            margin-left: 15px;
            font-weight: bold;
            color: #333;
            letter-spacing: 1.2px;
        }
        .seat-info .legend-selected {
            background: #28a745;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            border: 2px solid #28a745;
        }
        .seat-info .legend-available {
            background: #ccc;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            border: 2px solid #fff;
        }
        .seat-info .legend-unavailable {
            background: #dc3545;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            border: 2px solid #dc3545;
        }
        .stage {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 18px 0 13px 0;
        }
        .stage-rect {
            background: #333;
            color: #fff;
            font-weight: bold;
            border-radius: 11px;
            padding: 8px 60px;
            font-size: 1.17em;
            box-shadow: 0 2px 10px 0 #4443;
            text-align: center;
            border: 3px solid #007bff;
            letter-spacing: 1.5px;
        }
        #confirm-seats-button {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 9px 22px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.12em;
            margin-top: 11px;
            font-weight: bold;
            transition: background 0.15s, transform 0.11s;
        }
        #confirm-seats-button:hover {
            background: #218838;
            transform: scale(1.04);
        }
        #redirect-message {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #007bff;
            color: #fff;
            padding: 28px;
            border-radius: 19px;
            font-size: 1.15em;
            z-index: 1000;
            letter-spacing: 1.2px;
            font-weight: bold;
            text-shadow: 1px 1px 7px #22222244;
            box-shadow: 0 2px 18px 0 #2222;
        }
        /* START: Product Modal Styles */
        #product-modal {
            display: none;
            position: fixed;
            top: 0; right: 0; left: 0; bottom: 0;
            background: rgba(56, 56, 80, 0.22);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        #product-modal .modal-content {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 32px 0 #007bff22;
            display: flex;
            flex-direction: row;
            max-width: 520px;
            width: 95vw;
            padding: 0;
            overflow: hidden;
            position: relative;
        }
        #product-modal .modal-image {
            flex: 1.2;
            background: #f6faff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
        #product-modal .modal-image img {
            max-width: 97%;
            max-height: 320px;
            border-radius: 0 0 0 20px;
            object-fit: contain;
        }
        #product-modal .modal-details {
            flex: 2.2;
            padding: 24px 16px 18px 16px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        #product-modal .close-product-modal {
            position: absolute;
            top: 11px;
            left: 11px;
            background: none;
            border: none;
            font-size: 2em;
            color: #007bff;
            cursor: pointer;
            z-index: 5;
            transition: color 0.14s;
        }
        #product-modal .close-product-modal:hover {
            color: #dc3545;
        }
        #product-modal .modal-details h2 {
            margin: 0 0 7px 0;
            color: #007bff;
            font-size: 1.32em;
            white-space: pre-line;
        }
        #product-modal .modal-details .price {
            color: #27ae60;
            font-weight: bold;
            font-size: 1.08em;
            margin-bottom: 8px;
        }
        #product-modal .modal-details .description {
            color: #333;
            font-size: 1.05em;
            margin-bottom: 0;
            white-space: pre-line;
        }
        @media (max-width: 600px) {
            #product-modal .modal-content {
                flex-direction: column;
                max-width: 97vw;
                padding: 0;
            }
            #product-modal .modal-image img {
                max-height: 200px;
                border-radius: 20px 20px 0 0;
            }
        }
        /* END: Product Modal Styles */
        @media (max-width: 800px) {
            main#products-container {
                grid-template-columns: 1fr;
                padding: 24px 2vw 0 2vw;
            }
            #cart-container { width: 97vw; left: 1vw; }
            .stage-rect { padding: 4px 12vw; font-size: 1em;}
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <header>
    <img src="https://i.postimg.cc/ydWK80t5/Miller-logos-10.png" alt="לוגו" width="300" height="auto">
        <h1>אירועים בבית פאני קפלן - בית מילר</h1>
    </header>
    <button id="cart-toggle-button">הצג/הסתר עגלת קניות</button>
    <main id="products-container"></main>
    <div id="cart-container">
        <div id="cart">
            <h2>עגלת קניות</h2>
            <ul id="cart-items"></ul>
            <div class="total">סה"כ: <span id="cart-total">0.00</span> ₪</div>
            <button id="checkout-button">מעבר לתשלום</button>
        </div>
    </div>
    <div id="checkout-modal">
        <form id="checkout-form">
            <button type="button" class="close-modal-button">&times;</button>
            <h2>פרטי תשלום</h2>
            <div class="form-group">
                <label for="name">שם מלא:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="email">אימייל:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="phone">טלפון:</label>
                <input type="tel" id="phone" name="phone">
            </div>
            <div class="form-group">
                <label for="address">כתובת:</label>
                <input type="text" id="address" name="address" required>
            </div>
            <div class="form-group">
                <label for="card-number">מספר כרטיס אשראי:</label>
                <input type="text" id="card-number" name="cardNumber" inputmode="numeric" pattern="[0-9\s]{13,19}" autocomplete="cc-number" maxlength="19" placeholder="xxxx xxxx xxxx xxxx" required>
            </div>
            <div class="form-group">
                <label for="expiry-date">תאריך תפוגה (MM/YY):</label>
                <input type="text" id="expiry-date" name="expiryDate" pattern="(0[1-9]|1[0-2])\/([0-9]{2})" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" inputmode="numeric" pattern="[0-9]{3,4}" maxlength="4" required>
            </div>
            <div class="form-actions">
                <button type="submit">בצע תשלום (סימולציה)</button>
                <button type="button" class="close-modal-button">ביטול</button>
            </div>
        </form>
    </div>
    <div id="seat-selection-modal">
        <div class="seat-selection-content">
            <button type="button" class="close-modal-button">&times;</button>
            <h2>בחירת מקומות</h2>
            <div class="seats-grid" id="seats-grid"></div>
            <div class="seat-info">
                <span class="legend-selected"></span> מקום נבחר
                <span class="legend-available"></span> מקום פנוי
                <span class="legend-unavailable"></span> מקום תפוס
            </div>
            <div class="form-actions">
                <button id="confirm-seats-button">אישור מקומות</button>
            </div>
        </div>
    </div>
    <div id="redirect-message">
        מוזמנים לראות את שאר התוכנית שבית מילר מציעים...
    </div>
    <!-- Product Details Modal -->
    <div id="product-modal">
        <div class="modal-content">
            <button class="close-product-modal" type="button">&times;</button>
            <div class="modal-image">
                <img src="" alt="אירוע" id="modal-product-image">
            </div>
            <div class="modal-details">
                <h2 id="modal-product-title"></h2>
                <div class="price" id="modal-product-price"></div>
                <div class="description" id="modal-product-description"></div>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDlyDbpwcBcWvFnvYHb84dMEpaQFTjv-HY",
            authDomain: "tester-69fa9.firebaseapp.com",
            projectId: "tester-69fa9",
            storageBucket: "tester-69fa9.firebasestorage.app",
            messagingSenderId: "378563229004",
            appId: "1:378563229004:web:5136b724eb84fd00e44be9",
            measurementId: "G-BFJ1QQM3MS"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const productsContainer = document.getElementById('products-container');
        const cartItemsList = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');
        const checkoutButton = document.getElementById('checkout-button');
        const checkoutModal = document.getElementById('checkout-modal');
        const closeModalButtons = document.querySelectorAll('.close-modal-button');
        const checkoutForm = document.getElementById('checkout-form');
        const redirectMessage = document.getElementById('redirect-message');
        const cartToggleButton = document.getElementById('cart-toggle-button');
        const cartContainer = document.getElementById('cart-container');
        const seatSelectionModal = document.getElementById('seat-selection-modal');
        const seatsGrid = document.getElementById('seats-grid');
        const confirmSeatsButton = document.getElementById('confirm-seats-button');
        // Modal elements
        const productModal = document.getElementById('product-modal');
        const modalProductImage = document.getElementById('modal-product-image');
        const modalProductTitle = document.getElementById('modal-product-title');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalProductDescription = document.getElementById('modal-product-description');
        const closeProductModalBtn = document.querySelector('.close-product-modal');
        let cart = [];
        let currentProductForSeatSelection = null;
        let selectedSeatsForProduct = [];
        let allSeats = [];
        let products = [];
        const TOTAL_SEATS = 200;
        const SEATS_PER_ROW = 20;
        const STAGE_ROW = 0;
        async function initializeAllSeatsAsAvailable() {
            const seatsRef = db.collection('seats');
            const batch = db.batch();
            let seatsExist = false;
            const existingSeatsSnapshot = await seatsRef.limit(1).get();
            if (!existingSeatsSnapshot.empty) seatsExist = true;
            if (!seatsExist) {
                for (let i = 1; i <= TOTAL_SEATS; i++) {
                    const seatDocRef = seatsRef.doc(String(i));
                    batch.set(seatDocRef, { number: i, available: true, paid: false });
                }
                try { await batch.commit(); }
                catch (error) { console.error("Error initializing seats: ", error); }
            }
        }
        async function fetchProducts() {
            try {
                const productsSnapshot = await db.collection('products').get();
                products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            } catch (error) { alert("שגיאה בטעינת אירועים."); }
        }
        async function releaseExpiredHolds() {
            const now = Date.now();
            const seatsSnapshot = await db.collection('seats')
                .where('available', '==', false)
                .where('paid', '==', false)
                .get();
            const batch = db.batch();
            seatsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.heldUntil && now > data.heldUntil) {
                    const seatRef = db.collection('seats').doc(doc.id);
                    batch.update(seatRef, {
                        available: true,
                        heldUntil: firebase.firestore.FieldValue.delete(),
                        paid: false
                    });
                }
            });
            if (!seatsSnapshot.empty) await batch.commit();
        }
        async function fetchSeats() {
            await releaseExpiredHolds();
            try {
                const seatsSnapshot = await db.collection('seats').get();
                allSeats = seatsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allSeats.sort((a, b) => a.number - b.number);
            } catch (error) { alert("שגיאה בטעינת סטטוס מקומות."); }
        }
        async function holdSeatsTemporarily(seatIds) {
            const seatsRef = db.collection('seats');
            const batch = db.batch();
            const holdUntil = Date.now() + 5 * 60 * 1000;
            seatIds.forEach(seatId => {
                const seatRef = seatsRef.doc(String(seatId));
                batch.update(seatRef, {
                    available: false,
                    heldUntil: holdUntil,
                    paid: false
                });
            });
            try { await batch.commit(); }
            catch (error) {
                alert("שגיאה בהחזקת המקומות. נסה שוב.");
                await fetchSeats();
                renderSeats();
            }
        }
        async function markSeatsAsPaid(seatIds) {
            const seatsRef = db.collection('seats');
            const batch = db.batch();
            seatIds.forEach(seatId => {
                const seatRef = seatsRef.doc(String(seatId));
                batch.update(seatRef, {
                    paid: true,
                    heldUntil: firebase.firestore.FieldValue.delete()
                });
            });
            await batch.commit();
        }
        async function updateSeatAvailabilityInFirebase(seatIds, availableStatus) {
            const batch = db.batch();
            seatIds.forEach(seatId => {
                const seatRef = db.collection('seats').doc(String(seatId));
                batch.update(seatRef, { available: availableStatus });
            });
            try { await batch.commit(); }
            catch (error) {
                alert("שגיאה בעדכון זמינות המקומות. נסה שוב.");
                await fetchSeats();
                renderSeats();
            }
        }
        function renderProducts() {
            productsContainer.innerHTML = '';
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card');
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image" data-id="${product.id}">
                    <h3 class="product-title" data-id="${product.id}">${product.name}</h3>
                    <p class="price">${product.price.toFixed(2)} ₪</p>
                    <button class="add-to-cart" data-id="${product.id}">הוסף לעגלה</button>
                `;
                // click on image or title opens modal
                productCard.querySelector('.product-image').addEventListener('click', function(e) {
                    openProductModal(product.id);
                });
                productCard.querySelector('.product-title').addEventListener('click', function(e) {
                    openProductModal(product.id);
                });
                productsContainer.appendChild(productCard);
            });
        }
        function updateCartDisplay() {
            cartItemsList.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div class="cart-item-details">
                        <img src="${item.image}" alt="${item.name}">
                        <div class="cart-item-info">
                            <span>${item.name}</span>
                            <span>${item.price.toFixed(2)} ₪ ליחידה</span>
                            ${item.selectedSeats && item.selectedSeats.length > 0 ? `<br><span>מקומות: ${item.selectedSeats.map(s => s.number).join(', ')}</span>` : ''}
                        </div>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="decrease-quantity" data-id="${item.id}" data-type="cart">-</button>
                        <span>${item.quantity}</span>
                        <button class="increase-quantity" data-id="${item.id}" data-type="cart">+</button>
                    </div>
                    <span>סה"כ: ${(item.price * item.quantity).toFixed(2)} ₪</span>
                `;
                cartItemsList.appendChild(listItem);
                total += item.price * item.quantity;
            });
            cartTotalElement.textContent = total.toFixed(2);
            if (cart.length === 0) {
                const emptyCartMessage = document.createElement('li');
                emptyCartMessage.textContent = 'העגלה ריקה';
                cartItemsList.appendChild(emptyCartMessage);
                cartTotalElement.textContent = '0.00';
                checkoutButton.disabled = true;
            } else {
                checkoutButton.disabled = false;
            }
        }
        async function openSeatSelection(productId) {
            currentProductForSeatSelection = products.find(p => p.id === productId);
            selectedSeatsForProduct = [];
            const existingCartItem = cart.find(item => item.id === currentProductForSeatSelection.id);
            if (existingCartItem && existingCartItem.selectedSeats) {
                selectedSeatsForProduct = [...existingCartItem.selectedSeats];
            }
            await fetchSeats();
            renderSeats();
            seatSelectionModal.style.display = 'flex';
        }
        function renderSeats() {
            seatsGrid.innerHTML = '';
            const otherReservedSeats = new Set(
                cart
                    .filter(item => item.id !== currentProductForSeatSelection.id)
                    .flatMap(item => item.selectedSeats ? item.selectedSeats.map(s => s.id) : [])
            );
            let seatIndex = 0;
            let insertedStage = false;
            for (let row = 0; row < Math.ceil(TOTAL_SEATS / SEATS_PER_ROW); row++) {
                if (row === STAGE_ROW && !insertedStage) {
                    const stageDiv = document.createElement('div');
                    stageDiv.className = 'stage';
                    stageDiv.style.gridColumn = `1 / span ${SEATS_PER_ROW}`;
                    stageDiv.innerHTML = '<div class="stage-rect">במה</div>';
                    seatsGrid.appendChild(stageDiv);
                    insertedStage = true;
                }
                for (let col = 0; col < SEATS_PER_ROW; col++) {
                    if (seatIndex >= allSeats.length) break;
                    const seat = allSeats[seatIndex];
                    const seatElement = document.createElement('div');
                    seatElement.classList.add('seat');
                    seatElement.textContent = seat.number;
                    seatElement.dataset.id = seat.id;
                    const isAlreadySelected = selectedSeatsForProduct.some(s => s.id === seat.id);
                    const isUnavailable = !seat.available || (seat.heldUntil && Date.now() < seat.heldUntil && !seat.paid) || otherReservedSeats.has(seat.id);
                    if (isUnavailable) {
                        seatElement.classList.add('unavailable');
                    } else if (isAlreadySelected) {
                        seatElement.classList.add('selected');
                    }
                    seatElement.addEventListener('click', () => {
                        if (seatElement.classList.contains('unavailable')) {
                            return;
                        }
                        if (seatElement.classList.contains('selected')) {
                            seatElement.classList.remove('selected');
                            selectedSeatsForProduct = selectedSeatsForProduct.filter(s => s.id !== seat.id);
                        } else {
                            seatElement.classList.add('selected');
                            selectedSeatsForProduct.push(seat);
                        }
                    });
                    seatsGrid.appendChild(seatElement);
                    seatIndex++;
                }
            }
        }
        function addToCart(productId, selectedSeats = []) {
            const productToAdd = products.find(p => p.id === productId);
            let existingItemIndex = cart.findIndex(item => item.id === productToAdd.id);
            const previousSelectedSeatIds = existingItemIndex !== -1 && cart[existingItemIndex].selectedSeats
                ? cart[existingItemIndex].selectedSeats.map(s => s.id) : [];
            const newSelectedSeatIds = selectedSeats.map(s => s.id);
            const deselectedSeatIds = previousSelectedSeatIds.filter(id => !newSelectedSeatIds.includes(id));
            if (deselectedSeatIds.length > 0) {
                updateSeatAvailabilityInFirebase(deselectedSeatIds, true);
            }
            if (selectedSeats.length > 0) {
                if (existingItemIndex !== -1) {
                    cart[existingItemIndex].selectedSeats = selectedSeats;
                    cart[existingItemIndex].quantity = selectedSeats.length;
                } else {
                    cart.push({ ...productToAdd, quantity: selectedSeats.length, selectedSeats: selectedSeats });
                }
            } else {
                if (existingItemIndex !== -1) {
                    if (cart[existingItemIndex].selectedSeats && cart[existingItemIndex].selectedSeats.length > 0) {
                         cart.splice(existingItemIndex, 1);
                    } else {
                        cart[existingItemIndex].quantity++;
                    }
                } else {
                    cart.push({ ...productToAdd, quantity: 1, selectedSeats: [] });
                }
            }
            updateCartDisplay();
            cartContainer.style.display = 'block';
        }
        function changeQuantity(productId, change, type = 'cart') {
            const itemToUpdate = cart.find(item => item.id === parseInt(productId));
            if (itemToUpdate) {
                if (itemToUpdate.selectedSeats && itemToUpdate.selectedSeats.length > 0) {
                    alert('כדי לשנות כמות עבור פריט עם מקומות, יש לבחור מחדש את המקומות דרך לחצן "הוסף לעגלה" של האירוע.');
                    openSeatSelection(productId);
                    return;
                }
                itemToUpdate.quantity += change;
                if (itemToUpdate.quantity < 1) {
                    cart = cart.filter(item => item.id !== parseInt(productId));
                }
                updateCartDisplay();
            }
        }
        productsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-to-cart')) {
                openSeatSelection(event.target.dataset.id);
            }
        });
        cartItemsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('increase-quantity') || event.target.classList.contains('decrease-quantity')) {
                changeQuantity(event.target.dataset.id, event.target.classList.contains('increase-quantity') ? 1 : -1, 'cart');
            }
        });
        checkoutButton.addEventListener('click', () => {
            if (cart.length > 0) {
                checkoutModal.style.display = 'flex';
            } else {
                alert('העגלה ריקה, לא ניתן לבצע תשלום.');
            }
        });
        closeModalButtons.forEach(button => {
            button.addEventListener('click', () => {
                checkoutModal.style.display = 'none';
                seatSelectionModal.style.display = 'none';
                selectedSeatsForProduct = [];
            });
        });
        checkoutForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            try {
                const purchasedSeatsInfo = cart.flatMap(item => item.selectedSeats ? item.selectedSeats.map(s => ({
                    id: s.id,
                    number: s.number,
                    productName: item.name
                })) : []);
                const purchasedSeatIds = purchasedSeatsInfo.map(s => s.id);
                if (purchasedSeatIds.length > 0) {
                    await markSeatsAsPaid(purchasedSeatIds);
                }
                await db.collection('orders').add({
                    customerName: name,
                    customerEmail: email,
                    customerPhone: phone,
                    customerAddress: address,
                    items: cart.map(item => ({
                        productId: item.id,
                        productName: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        selectedSeats: item.selectedSeats ? item.selectedSeats.map(s => s.number) : []
                    })),
                    totalAmount: parseFloat(cartTotalElement.textContent),
                    orderDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                });
                alert(`תודה לך, ${name}! הזמנתך התקבלה בהצלחה.\nסך הכל לתשלום: ${cartTotalElement.textContent}`);
                cart = [];
                updateCartDisplay();
                checkoutModal.style.display = 'none';
                checkoutForm.reset();
                redirectMessage.style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'https://bmiller.co.il';
                }, 3000);
            } catch (error) {
                alert("אירעה שגיאה בתהליך התשלום. נסה שוב.");
                await fetchSeats();
                renderSeats();
            }
        });
        cartToggleButton.addEventListener('click', () => {
            if (cartContainer.style.display === 'none') {
                cartContainer.style.display = 'block';
            } else {
                cartContainer.style.display = 'none';
            }
        });
        confirmSeatsButton.addEventListener('click', async () => {
            if (currentProductForSeatSelection) {
                if (selectedSeatsForProduct.length === 0) {
                     const confirmRemove = confirm("לא נבחרו מקומות עבור אירוע זה. האם ברצונך להסיר אותו מהעגלה?");
                     if (confirmRemove) {
                        cart = cart.filter(item => item.id !== currentProductForSeatSelection.id);
                     } else {
                        return;
                     }
                } else {
                    const seatIds = selectedSeatsForProduct.map(s => s.id);
                    await holdSeatsTemporarily(seatIds);
                }
                addToCart(currentProductForSeatSelection.id, selectedSeatsForProduct);
            }
            seatSelectionModal.style.display = 'none';
        });
        setInterval(releaseExpiredHolds, 60 * 1000);
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAllSeatsAsAvailable();
            await fetchProducts();
            await fetchSeats();
            updateCartDisplay();
        });

        // Product modal logic
        function openProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            modalProductImage.src = product.image;
            modalProductImage.alt = product.name;
            modalProductTitle.textContent = product.name;
            modalProductPrice.textContent = `${product.price.toFixed(2)} ₪`;
            modalProductDescription.textContent = product.description ? product.description : '';
            productModal.style.display = 'flex';
        }
        function closeProductModal() {
            productModal.style.display = 'none';
        }
        closeProductModalBtn.addEventListener('click', closeProductModal);
        // Close modal on outside click
        productModal.addEventListener('mousedown', function(e) {
            if (e.target === productModal) {
                closeProductModal();
            }
        });
        // Optionally: ESC key closes modal
        window.addEventListener('keydown', function(e) {
            if (productModal.style.display === 'flex' && e.key === 'Escape') {
                closeProductModal();
            }
        });
    </script>
</body>
</html>
